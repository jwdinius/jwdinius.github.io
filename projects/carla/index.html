<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Self-Driving Car | Joe Dinius, Ph.D.</title> <meta name="author" content="Joe Dinius, Ph.D."> <meta name="description" content="ROS - Perception &amp; Control"> <meta name="keywords" content="robotics, autonomy, math, optimization, controltheory, planning, computervision"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?53ca2be8c4ec0d533ef79017d1a2d734"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://jwdinius.github.io/projects/carla/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Joe </span>Dinius, Ph.D.</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">git</a> </li> <li class="nav-item "> <a class="nav-link" href="/learning/">learning</a> </li> <li class="nav-item "> <a class="nav-link" href="/assets/pdf/resumeDiniusTargeted.pdf">resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Self-Driving Car</h1> <p class="post-description">ROS - Perception &amp; Control</p> </header> <article> <h2 id="abstract">Abstract</h2> <p>I recently had the chance to write code to run on Carla, Udacity’s self-driving car. The car’s perception, planning, and controls modules were written on top of an existing ROS framework. To test out the efficacy of the written code, simulation experiments were performed using all-digital simulations and pre-recorded ROS bagfiles. This project write-up describes the project, the approaches considered, and some results. The end product was the following <a href="https://github.com/jwdinius/CarND-Term3/tree/master/CarND-Capstone-NPLH" rel="external nofollow noopener" target="_blank">code repository</a>.</p> <h2 id="outline">Outline</h2> <p>Udacity has <a href="https://medium.com/udacity/how-the-udacity-self-driving-car-works-575365270a40" rel="external nofollow noopener" target="_blank">Carla, the self-driving car</a>, and, in a very unique offering, they allow students taking the third term of the <a href="https://www.udacity.com/course/self-driving-car-engineer-nanodegree--nd013" rel="external nofollow noopener" target="_blank">Self-Driving Car Engineering Nanodegree</a> to write code that will run on it. This write-up is a walkthrough of the approach that my team took to write the perception and control logic for safely driving the car.</p> <p>The project began with team formation. Team formation was voluntary and tracked via a Google Docs spreadsheet. I led the team <em>No Place Like Home</em>, composed of four other members and myself. All of us were running a bit behind schedule and we had a mutual incentive to complete the project on a particular timeline. Team formation proved to be a major factor in the project; more on this later.</p> <p>The following system diagram shows the interconnections between different subsystems on Carla, and it provides a nice pictorial introduction to the logic that needed to be written:</p> <p><img src="/assets/img/carla/final-project-ros-graph-v2.png" alt="system_diagram"></p> <p>This project is broken into the following steps:</p> <ul> <li><strong>Perception</strong></li> <li><strong>Planning</strong></li> <li><strong>Control</strong></li> </ul> <p>The <strong>Perception</strong> step involved obstacle avoidance and traffic light detection. The obstacle avoidance piece was not covered in this project. The goal here was to create a working traffic light detector that would tell the planner when to stop for red lights.</p> <p>The <strong>Planning</strong> step was to create a way of handling car behavior at pre-defined waypoints along specific tracks. There are two tracks</p> <ul> <li>Simulation - used for basic logic testing and debugging</li> <li>Site - the actual test track that Carla drives around</li> </ul> <p>The <strong>Control</strong> step handled the drive-by-wire, DBW, logic for smooth steering and throttle/brake commands to send to the actuators.</p> <p>Each step was worked on by different team members in parallel. My individual responsibilities were the <strong>Planning</strong> module, administration and team planning, and system integration. I will present here all of the work that the team accomplished to get the code up and running on Carla.</p> <h2 id="preliminaries">Preliminaries</h2> <p>The team was provided with a <a href="https://github.com/udacity/CarND-Capstone" rel="external nofollow noopener" target="_blank">basic repo</a> with communication between nodes plumbed out. The interprocess communication layers were built using <a href="http://www.ros.org/" rel="external nofollow noopener" target="_blank">ROS</a>, an ever-more popular starting point for robotics projects because of its large user base and many success stories. ROS also has many debugging tools, such as <a href="http://wiki.ros.org/rviz" rel="external nofollow noopener" target="_blank">rviz</a>, good logging capabilities, and plotting tools. All of these tools come with a nice python interface.</p> <h2 id="perception">Perception</h2> <p>Since the obstacle avoidance part of the perception layer was out-of-scope for this project, the only remaining task was to build a traffic light detector capable of both detecting traffic lights and classifying the color observed. The approach our team took was inspired by <a href="https://becominghuman.ai/traffic-light-detection-tensorflow-api-c75fdbadac62" rel="external nofollow noopener" target="_blank">this blog post</a>. A quick synopsis is that we built an integrated bounding-box detector and classifier using the <em>Resnet 101</em> model. Two separate inference graphs were generated: one for the simulation and another for implementation on the real car. We were able to implement these two separate graphs within a single ROS codebase with the addition of a simple <code class="language-plaintext highlighter-rouge">sim</code> parameter defined in the launchfiles.</p> <p>Typical standalone perception results are shown below:</p> <p><a href="https://www.youtube.com/watch?v=7tjPTK19POg" target="_blank" rel="external nofollow noopener"><img src="https://img.youtube.com/vi/7tjPTK19POg/0.jpg" alt="site_test_bag"></a></p> <p>The video shows classification accuracy in the terminal window at the left. The camera video playback and the ros bag output are also displayed. The classification results match the observed light colors from the video playback, with accuracies well above 90%.</p> <p>The classification accuracies are impressive, but in practice the classification pipeline using this particular neural network architecture was quite slow, and this led to integration issues later on. I will discuss this more later.</p> <h2 id="planning">Planning</h2> <p>The planning step is the one I was most directly involved in with respect to code architecture and implementation. We were provided a set of waypoints via csv files for both the simulation and the site tracks. Each waypoint had a pose and an associated velocity. The goal of this step was to set desired velocities incorporating output from the traffic light detector and the waypoint loader. These desired velocities were then passed to the control layer to generate actuator commands.</p> <p>The particular strategy I employed was simple: through subscription to the traffic light publisher, the waypoint index and subsequent location of red lights are determined. If a red light was detected at an upcoming waypoint, a linear ramp down to 0 of the longitudinal velocity is commanded.</p> <p>The output of this step is a set of waypoints ahead of the current one, along with a desired velocity at each waypoint.</p> <h2 id="control">Control</h2> <p>The control step generated drive-by-wire steering and throttle commands by passing the outputs of the planner through a low-pass filter. The filter was provided as part of the base repository, as was the PID controller logic that was used to zero out errors between the desired and achieved vehicle responses.</p> <h2 id="integration">Integration</h2> <p>Bringing all of these pieces together was difficult…</p> <p>Aside from team members scattered throughout the world with various personal commitments, the technical piece alone was quite difficult. Getting all of the pieces to work on both the simulation and pre-recorded bag files required many hours of effort; iteration-after-iteration was performed to get better performance. Simulation results are shown below:</p> <p><a href="https://www.youtube.com/watch?v=VbBsrrDvEf0" target="_blank" rel="external nofollow noopener"><img src="https://img.youtube.com/vi/VbBsrrDvEf0/0.jpg" alt="submission_sim"></a></p> <p>The simulated car stops at red lights, indicating the classifier is working, and stays in the lane, indicating the DBW logic is functioning correctly too. We thought we were ready to run on the real car at this point, so we submitted our code for running on Carla.</p> <p>Fast-forward two weeks… That’s right, it was two weeks to get feedback. We got the ros bagfile and feedback on our submission. The video below shows the reviewer’s response to our submission. Aside from the jerky startup at the initiation of drive-by-wire control, the vehicle appeared to drive quite smoothly. The reviewer even commented with “Nice Job”.</p> <p><a href="https://www.youtube.com/watch?v=lNJQDRigO9g" target="_blank" rel="external nofollow noopener"><img src="https://img.youtube.com/vi/lNJQDRigO9g/0.jpg" alt="site_feedback"></a></p> <p>We were feeling pretty good about our submission at this point, but deeper inspection of the bagfile left us feeling not so great, see the video below:</p> <p><a href="https://www.youtube.com/watch?v=ByDRA8uefmQ" target="_blank" rel="external nofollow noopener"><img src="https://img.youtube.com/vi/ByDRA8uefmQ/0.jpg" alt="site_bag"></a></p> <p>The car appears to go through a red light! Digging through the logfiles showed that the traffic light detector had failed to come up in time to detect the red light. By the time the node had come up and was functioning, the car had already driven through the red light. This was disheartening, but the team seemed interested in fixing and resubmitting.</p> <p>“Seemed” was perhaps the opportune word in the above sentence. Of the four other team members, only one other member put in any additional effort, and even that was very limited. The criteria for graduation from the program was submission <em>only</em> of project code. Ultimately, it is up to each individual team to decide when they are satisfied with the results. Apparently, the rest of our team was satisfied with the results, but I wasn’t. I then put together another submission that addressed the issues of the first submission, namely the following:</p> <ul> <li>Abrupt transition when engaging the drive-by-wire control</li> <li>Traffic light detection engages too late</li> </ul> <p>After digging through the code, I found that the filtering strategy being used was to blame for the abrupt transition; acceleration commands at initiation were spiking. The second issue was more subtle, and I had a lot of difficulty addressing this. Ultimately, my strategy was to give a little more time for the traffic light detection node to initialize by slowly increasing the waypoint speed to it’s maximum value when the ros processes first come up. I made these changes, and resubmitted.</p> <p><a href="https://www.youtube.com/watch?v=hIMgtaHPAqY" target="_blank" rel="external nofollow noopener"><img src="https://img.youtube.com/vi/hIMgtaHPAqY/0.jpg" alt="sim_resubmit"></a></p> <p>The above simulation results show the desired effects of the changes. The vehicle slowly increases speed upon initiation. The first light is resolved with plenty of distance to stop. Not shown: the filtered steering and throttle commands no longer spike at instantiation.</p> <p>The output from Carla was not as expected. The log seems to indicate that the traffic light detection node failed to spin up in time again. On the plus side, the drive-by-wire behavior was much smoother. At this point, simulation behavior was dificult to correlate to actual vehicle behavior. Despite my desire to get the code really working on Carla, the time to feedback and the inability to debug issues in real-time made me realize that further efforts would not be fruitful.</p> <h2 id="challenges">Challenges</h2> <ul> <li>The biggest challenge faced was the submission-feedback timeline. Our first submission took over a week to get feedback, at which time there was a technical issue on Udacity’s side that forced us to resubmit and wait another week for results. For the two submissions made, the <em>average</em> time to feedback was over two weeks. With everything else going on in my life, it was difficult to stay focused on this project.</li> <li>The test track at the site only had one traffic light at the very beginning, and therefore debugging the system under steady-state conditions was next to impossible.</li> <li>Vehicle behavior between the test track and the simulator were qualitatively different. Simulation results showed expected output: stopping at red lights, maintaining constant speed between lights, and lane-keeping. The track behavior, on the other hand, showed an inability to stop at the traffic light.</li> <li>Team members had widely varying levels of engagement with the project. Some team members were active contributors, while others actually made more work for the rest of us.</li> </ul> <h2 id="concluding-remarks">Concluding Remarks</h2> <p>This project was a lot of fun to work on. I got a chance to do some project management during execution of a complicated project with multiple participants. I also got a chance to work with an exciting platform for robotics development, ROS, applied to a real self-driving car. I would have liked there to have been a better matching between simulation and real vehicle behaviors, as this would have made debugging much easier. All-in-all, I had a great time working on this and although I’m a bit disappointed with the end result, it was a great experience.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Joe Dinius, Ph.D.. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>