<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Smooth Path Planning - overlaying a velocity profile | Joe Dinius, Ph.D.</title> <meta name="author" content="Joe Dinius, Ph.D."> <meta name="description" content="Simple curve-geometric trajectory generation"> <meta name="keywords" content="robotics, autonomy, math, optimization, controltheory, planning, computervision"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?53ca2be8c4ec0d533ef79017d1a2d734"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://jwdinius.github.io/blog/2018/eta3traj/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Joe </span>Dinius, Ph.D.</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">git</a> </li> <li class="nav-item "> <a class="nav-link" href="/learning/">learning</a> </li> <li class="nav-item "> <a class="nav-link" href="/assets/pdf/resumeDiniusTargeted.pdf">resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Smooth Path Planning - overlaying a velocity profile</h1> <p class="post-meta">September 2, 2018</p> <p class="post-tags"> <a href="/blog/2018"> <i class="fa-solid fa-calendar fa-sm"></i> 2018 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p><a href="https://github.com/jwdinius/PythonRobotics/tree/eta3_traj2" rel="external nofollow noopener" target="_blank">Repo</a></p> <h3 id="introduction">Introduction</h3> <p>This post extends work discussed <a href="/blog/2018/eta3path">previously</a>. In that post, I presented a method for constructing geometrically-continuous paths up to third-order. I will now discuss how to take that path and build a trajectory that drives along it. The notion of “drives” is important here: trajectory motion is assumed <em>tangent</em> to the path. This restriction refers to car-like robots that, under normal conditions, point their front-end in the direction of motion.</p> <p>In this context, “trajectory” means a time-series of pose data, \((x,y,\theta)\), along with controls, \((v,\omega)\), that define a motion profile for a <a href="https://en.wikipedia.org/wiki/Differential_wheeled_robot" rel="external nofollow noopener" target="_blank">differential-drive robot</a>. Importantly, the method that I discuss here can be applied to any underlying path geometry, not just \(\eta^3\)-splines.</p> <p>Before going into the method, I will outline some constraints that are imposed to make the problem tractable:</p> <ul> <li>Trajectories have fixed initial condition. The robot begins at known velocity \(v_0 \le v_{max}\) and acceleration \(a_0 \le a_{max}\), where \(v_{max}, a_{max}\) are the maximum velocity and acceleration, respectively.</li> <li>Trajectories must terminate with zero velocity <em>and</em> acceleration. This makes sense, because most objectives involve getting to some particular waypoint before being assigned a new task/action.</li> <li>Kinematic limits must be obeyed everywhere along the trajectory. These limits are on velocity, acceleration, and jerk.</li> <li>The kinematic limits are symmetric: \(*_{min} = -*_{max}\).</li> <li>The maximum velocity may need to be reduced to accommodate the other two constraints. It may not be feasible to reach the desired maximum velocity given the length of the underlying path and the maximum acceleration and jerk limits.</li> </ul> <h3 id="the-method">The Method</h3> <p>The method I propose here is homespun in that I have not found many resources that approach the problem in a similar way. In a nutshell, the robot begins by applying the maximum jerk, \(j_{max}\), until the maximum acceleration is reached. Once maximum acceleration has been achieved, the robot will continue accelerating until the time when minimum jerk, \(j_{min} = -j_{max}\), needs to be applied to smoothly transition from acceleration to maximum speed with zero acceleration. At this point, if there is enough path length to do so, the robot will cruise at the maximum speed \(v_{max}\). Otherwise, the robot will continue applying minimum jerk until maximum deceleration has been achieved. Deceleration at maximum rate continues until the time when the robot needs to apply maximum jerk to finish at zero velocity and zero acceleration.</p> <p>Before going through each section in more detail, a kinematic assessment needs to be made regarding whether or not the maximum velocity can be achieved given the other limits and the path given. This analysis requires a shooting method, of sorts, where a trajectory starting at the given initial conditions is shot forwards in time and a trajectory starting from the desired terminal condition is shot backwards in time. The terminal point in time of each trajectory is when it reaches the <em>desired</em> velocity \(v_{max}\). The intersection of the two trajectories is then analyzed based upon the sum of the two trajectory lengths. If this sum is greater than the total path length, then the desired maximum velocity, \(v_{max}\) cannot be achieved and the maximum velocity must be adjusted, \(v'_{max} &lt; v_{max}\). Otherwise, \(v'_{max} = v_{max}\) and there will be some amount of <em>cruising</em> time; time where the robot moves at \(v'_{max}\).</p> <p>For details of how this analysis is done in practice, please see the <a href="https://github.com/jwdinius/PythonRobotics/tree/eta3_traj2" rel="external nofollow noopener" target="_blank">implementation</a>.</p> <p>I’ll now go through the math for each section.</p> <h4 id="section-1-maximum-jerk-part-1">Section 1: Maximum jerk, part 1</h4> <p>The robot starts at $v = v_0$ and $a=a_0$. The amount of time needed to get to maximum acceleration from the initial acceleration $a_0$ is:</p> \[\begin{eqnarray} \Delta a &amp;=&amp; a_{max} - a_0 \\ \Delta t &amp;=&amp; \frac{\Delta a}{j_{max}} \end{eqnarray}\] <p>Let $s_{s_1}$ denote the path length traversed by the robot while applying maximum jerk:</p> \[\begin{eqnarray} s_{s_1} &amp;=&amp; v_0 \Delta t + \frac{1}{2} a_0 \Delta t^2 + \frac{1}{6} j_{max} \Delta t^3. \\ v_{s_1} &amp;=&amp; v_0 + \frac{1}{2} j_{max} \Delta t^2 \end{eqnarray}\] <h4 id="section-2-maximum-acceleration">Section 2: Maximum acceleration</h4> <p>The robot continues at maximum acceleration until it needs to begin slowing down to hit $v_{max}$. The time-of-traversal for this second section is:</p> \[\begin{eqnarray} v_f &amp;\equiv&amp; v'_{max} - \frac{a_{max}^2}{2 j_{max}} \\ \Delta v &amp;=&amp; v_f - v_{s_1} \\ \Delta t &amp;=&amp; \frac{\Delta v}{a_{max}} \end{eqnarray}\] <p>Let $s_{s_2}$ denote the path length traversed by the robot while applying maximum acceleration:</p> \[\begin{eqnarray} s_{s_2} &amp;=&amp; v_{s_1} \Delta t + \frac{1}{2} a_{max} \Delta t^2 \\ v_{s_2} &amp;=&amp; v_{s_1} + a_{max} \Delta t. \end{eqnarray}\] <h4 id="section-3-minimum-jerk-part-1">Section 3: Minimum jerk, part 1</h4> <p>In order to obey the jerk limits, the robot must apply minimum jerk to take out all of the acceleration.</p> \[\begin{eqnarray} \Delta a &amp;=&amp; 0 - a_{max} = -a_{max} \\ \Delta t &amp;=&amp; \frac{-a_{max}}{j_{min}} = \frac{a_{max}}{j_{max}} \end{eqnarray}\] <p>Let $s_{s_3}$ denote the path length traversed by the robot while applying minimum jerk:</p> \[\begin{eqnarray} s_{s_3} &amp;=&amp; v_{s_2} \Delta t + \frac{1}{6} j_{min} \Delta t^3 \\ v_{s_3} &amp;=&amp; v_{s_2} + \frac{1}{2} j_{min} \Delta t^2. \end{eqnarray}\] <h4 id="section-4-cruise-initial-consideration">Section 4: Cruise, initial consideration.</h4> <p>If the initial analysis showed that there was remaining path after doing the shooting method discussed, then there will be a cruise section. The math of the cruise section is the easiest because there is no velocity change. Logically, it makes the most sense to consider this segment last, because we will take whatever unaccounted-for length and apply it as a cruise section.</p> <h4 id="section-5-minimum-jerk-part-2">Section 5: Minimum jerk, part 2</h4> <p>At the end of the cruise section, or the end of the first minimum jerk section if there is no cruise section, apply minimum jerk again until max <em>deceleration</em> is reached.</p> \[\begin{eqnarray} \Delta a &amp;=&amp; a_{min} - 0 = -a_{max} \\ \Delta t &amp;=&amp; \frac{-a_{max}}{j_{min}} = \frac{a_{max}}{j_{max}} \end{eqnarray}\] <p>Let $s_{s_3}$ denote the path length traversed by the robot while again applying minimum jerk:</p> \[\begin{eqnarray} s_{s_5} &amp;=&amp; v'_{max} \Delta t + \frac{1}{6} j_{min} \Delta t^3 \\ v_{s_5} &amp;=&amp; v'_{max} + \frac{1}{2} j_{min} \Delta t^2. \end{eqnarray}\] <h4 id="section-6-minimum-acceleration">Section 6: Minimum acceleration</h4> <p>The robot will continue decelerating at \(a_{min}\) until the time when it needs to apply maximum jerk to hit the terminal constraint of zero velocity and acceleration.</p> \[\begin{eqnarray} \Delta v &amp;=&amp; v_{s_5} - \frac{a_{min}^2}{2 j_{max}} \\ \Delta t &amp;=&amp; \frac{\Delta v}{a_{max}} \end{eqnarray}\] <p>Let $s_{s_6}$ denote the path length traversed by the robot while applying minimum acceleration:</p> \[\begin{eqnarray} s_{s_6} &amp;=&amp; v_{s_5} \Delta t + \frac{1}{2} a_{min} \Delta t^2 \\ v_{s_6} &amp;=&amp; v_{s_5} + a_{min} \Delta t. \end{eqnarray}\] <h4 id="section-7-maximum-jerk-part-2">Section 7: Maximum jerk, part 2</h4> <p>Finally, to come to a stop at zero velocity we again apply maximum jerk. \(\begin{eqnarray} \Delta a &amp;=&amp; 0-a_{min} = a_{max} \\ \Delta t &amp;=&amp; \frac{\Delta a}{j_{max}} \end{eqnarray}\)</p> <p>Let $s_{s_7}$ denote the path length traversed by the robot while again applying maximum jerk:</p> \[\begin{eqnarray} s_{s_7} &amp;=&amp; v_{s_6} \Delta t - \frac{1}{6} j_{max} \Delta t^3. \\ v_{s_7} &amp;=&amp; v_{s_6} - \frac{1}{2} j_{max} \Delta t^2 \end{eqnarray}\] <h4 id="section-4-cruise-final-consideration">Section 4: Cruise, final consideration</h4> <p>At this point, we have everything we need to determine how long of a section we will be able to cruise along at \(v'_{max}\). Upon construction of the path, we computed a total segment length, \(s_{tot}\), from which we will now subtract all of the computed segment lengths thus far:</p> \[\begin{eqnarray} s_{s_4} &amp;=&amp; s_{tot} - \sum_{i \neq 4} s_{s_i} \\ \Delta t &amp;=&amp; \frac{v'_{max}}{s_{s_4}}, \end{eqnarray}\] <p>where, again, \(\Delta t\) is the time-of-traversal.</p> <h3 id="implementation-details">Implementation Details</h3> <h4 id="finding-the-point-along-the-curve-at-a-given-timevelocity">Finding the point along the curve at a given time/velocity</h4> <p>Recall that paths are typically composed of segments stitched together, each one of which is parametrized by a continuous parameter \(u \in [0, 1]\). Now that we are trying to overlay a velocity profile on top of these path segments, we need to be careful to correctly map our current point, as constructed by our integrated velocity profile, \(s(t) = \int_0^t v(\tau) d \tau\), to the corresponding \(u\) on the current path. The objective, stated mathematically, is:</p> <blockquote> <p>For any \(t \in [0, T]\), \(T\) is the final trajectory time, find the \(u\) along the path such that \(\begin{equation} s(u) \equiv \int_0^{u} \dot s(\tau) d \tau = \int_0^t v(\tau) d \tau \end{equation}\) given a velocity profile that also parametrizes the path. \(\dot s(\tau) \equiv \sqrt{\dot x(\tau)^2 + \dot y(\tau)^2}\).</p> </blockquote> <p>This problem is solved using the <a href="https://en.wikipedia.org/wiki/Fundamental_theorem_of_calculus" rel="external nofollow noopener" target="_blank">Fundamental Theorem of Calculus, part 1</a> together with a <a href="https://en.wikipedia.org/wiki/Newton%27s_method" rel="external nofollow noopener" target="_blank">Newton iteration</a> scheme. The basic idea is that the two methods are used together to find the root of the nonlinear equation:</p> \[\begin{equation} f(u) = \int_0^u \dot s(\tau) d \tau - \int_0^t v(t) dt, \end{equation}\] <p>where \(t, v(t)\) are known and \(s(\tau)\) is constructed during the initial path building step.</p> <h3 id="application">Application</h3> <p>I begin with the path constructed in the <a href="../eta3path">previous post</a>:</p> <p align="center"> <img src="/assets/img/smooth_path_post/Eta3Path.png"> </p> <p>Now, I apply kinematic limits of \((v_{max}, a_{max}, j_{max}) = (2, 0.5, 1)\), where all units are SI. The resulting trajectory, represented as a colormap, is:</p> <p align="center"> <img src="/assets/img/trajectory_planner/colormap.png"> </p> <p>The velocity profiles, shown on one chart with two \(y\)-axes, is:</p> <p align="center"> <img src="/assets/img/trajectory_planner/velocities.png"> </p> <p>As expected, given the work on the <a href="../eta3path">path planner</a>, the angular velocity is continuous. For most applications, this is very important, as the angular velocity can lead to wheel slip, instability, or other undesirable effects.</p> <h3 id="concluding-remarks">Concluding Remarks</h3> <p>A way of overlaying a velocity profile over a segments connecting multiple waypoints was presented. The velocity profile constructed obeys kinematic limits for maximum velocity, acceleration, and jerk. The angular velocity signal was shown to be continuous, which reinforces the idea continuous curvature presented in the <a href="blog/2018/eta3path">\(\eta^3\) spline path planner</a>. This mini-project was interesting and fun to work on. I hope that you, the interested reader, will find something worthwhile in either this post or my work supporting it. Cheers!</p> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Joe Dinius, Ph.D.. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>