<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Smooth Path Planning - overlaying a velocity profile | </title>
    <meta name="author" content="Joe  Dinius">
    <meta name="description" content="Simple curve-geometric trajectory generation">
    <meta name="keywords" content="robotics, autonomy, applied-math">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://jwdinius.github.io/blog/2018/eta3traj/">
    
    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"></a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">
        <!-- CV link -->
        <a class="page-link" href="https://jwdinius.github.io/assets/pdf/resumeDiniusTargeted.pdf">resume</a>

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/"></a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">Joe's blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">portfolio</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/repositories/">repositories</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/">cv</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/teaching/">teaching</a>
              </li>
              <li class="nav-item dropdown ">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/publications/">publications</a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="/projects/">projects</a>
                </div>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Smooth Path Planning - overlaying a velocity profile</h1>
    <p class="post-meta">September 2, 2018</p>
    <p class="post-tags">
      <a href="/blog/2018"> <i class="fas fa-calendar fa-sm"></i> 2018 </a>

    </p>
  </header>

  <article class="post-content">
    <p><a href="https://github.com/jwdinius/PythonRobotics/tree/eta3_traj2" rel="external nofollow noopener" target="_blank">Repo</a></p>

<h3 id="introduction">Introduction</h3>
<p>This post extends work discussed <a href="/blog/2018/eta3path">previously</a>.  In that post, I presented a method for constructing geometrically-continuous paths up to third-order.  I will now discuss how to take that path and build a trajectory that drives along it.  The notion of “drives” is important here: trajectory motion is assumed <em>tangent</em> to the path.  This restriction refers to car-like robots that, under normal conditions, point their front-end in the direction of motion.</p>

<p>In this context, “trajectory” means a time-series of pose data, \((x,y,\theta)\), along with controls, \((v,\omega)\), that define a motion profile for a <a href="https://en.wikipedia.org/wiki/Differential_wheeled_robot" rel="external nofollow noopener" target="_blank">differential-drive robot</a>.  Importantly, the method that I discuss here can be applied to any underlying path geometry, not just \(\eta^3\)-splines.</p>

<p>Before going into the method, I will outline some constraints that are imposed to make the problem tractable:</p>

<ul>
  <li>Trajectories have fixed initial condition.  The robot begins at known velocity \(v_0 \le v_{max}\) and acceleration \(a_0 \le a_{max}\), where \(v_{max}, a_{max}\) are the maximum velocity and acceleration, respectively.</li>
  <li>Trajectories must terminate with zero velocity <em>and</em> acceleration.  This makes sense, because most objectives involve getting to some particular waypoint before being assigned a new task/action.</li>
  <li>Kinematic limits must be obeyed everywhere along the trajectory.  These limits are on velocity, acceleration, and jerk.</li>
  <li>The kinematic limits are symmetric:  \(*_{min} = -*_{max}\).</li>
  <li>The maximum velocity may need to be reduced to accommodate the other two constraints.  It may not be feasible to reach the desired maximum velocity given the length of the underlying path and the maximum acceleration and jerk limits.</li>
</ul>

<h3 id="the-method">The Method</h3>
<p>The method I propose here is homespun in that I have not found many resources that approach the problem in a similar way.  In a nutshell, the robot begins by applying the maximum jerk, \(j_{max}\), until the maximum acceleration is reached.  Once maximum acceleration has been achieved, the robot will continue accelerating until the time when minimum jerk, \(j_{min} = -j_{max}\), needs to be applied to smoothly transition from acceleration to maximum speed with zero acceleration.  At this point, if there is enough path length to do so, the robot will cruise at the maximum speed \(v_{max}\).  Otherwise, the robot will continue applying minimum jerk until maximum deceleration has been achieved.  Deceleration at maximum rate continues until the time when the robot needs to apply maximum jerk to finish at zero velocity and zero acceleration.</p>

<p>Before going through each section in more detail, a kinematic assessment needs to be made regarding whether or not the maximum velocity can be achieved given the other limits and the path given.  This analysis requires a shooting method, of sorts, where a trajectory starting at the given initial conditions is shot forwards in time and a trajectory starting from the desired terminal condition is shot backwards in time.  The terminal point in time of each trajectory is when it reaches the <em>desired</em> velocity \(v_{max}\).  The intersection of the two trajectories is then analyzed based upon the sum of the two trajectory lengths.  If this sum is greater than the total path length, then the desired maximum velocity, \(v_{max}\) cannot be achieved and the maximum velocity must be adjusted, \(v'_{max} &lt; v_{max}\).  Otherwise, \(v'_{max} = v_{max}\) and there will be some amount of <em>cruising</em> time; time where the robot moves at \(v'_{max}\).</p>

<p>For details of how this analysis is done in practice, please see the <a href="https://github.com/jwdinius/PythonRobotics/tree/eta3_traj2" rel="external nofollow noopener" target="_blank">implementation</a>.</p>

<p>I’ll now go through the math for each section.</p>

<h4 id="section-1-maximum-jerk-part-1">Section 1: Maximum jerk, part 1</h4>
<p>The robot starts at $v = v_0$ and $a=a_0$.  The amount of time needed to get to maximum acceleration from the initial acceleration $a_0$ is:</p>

\[\begin{eqnarray}
\Delta a &amp;=&amp; a_{max} - a_0 \\
\Delta t &amp;=&amp; \frac{\Delta a}{j_{max}}
\end{eqnarray}\]

<p>Let $s_{s_1}$ denote the path length traversed by the robot while applying maximum jerk:</p>

\[\begin{eqnarray}
s_{s_1} &amp;=&amp; v_0 \Delta t + \frac{1}{2} a_0 \Delta t^2 + \frac{1}{6} j_{max} \Delta t^3. \\
v_{s_1} &amp;=&amp; v_0 + \frac{1}{2} j_{max} \Delta t^2
\end{eqnarray}\]

<h4 id="section-2-maximum-acceleration">Section 2: Maximum acceleration</h4>
<p>The robot continues at maximum acceleration until it needs to begin slowing down to hit $v_{max}$.  The time-of-traversal for this second section is:</p>

\[\begin{eqnarray}
v_f &amp;\equiv&amp; v'_{max} - \frac{a_{max}^2}{2 j_{max}} \\
\Delta v &amp;=&amp; v_f - v_{s_1} \\
\Delta t &amp;=&amp; \frac{\Delta v}{a_{max}}
\end{eqnarray}\]

<p>Let $s_{s_2}$ denote the path length traversed by the robot while applying maximum acceleration:</p>

\[\begin{eqnarray}
s_{s_2} &amp;=&amp; v_{s_1} \Delta t + \frac{1}{2} a_{max} \Delta t^2 \\
v_{s_2} &amp;=&amp; v_{s_1} + a_{max} \Delta t.
\end{eqnarray}\]

<h4 id="section-3-minimum-jerk-part-1">Section 3: Minimum jerk, part 1</h4>

<p>In order to obey the jerk limits, the robot must apply minimum jerk to take out all of the acceleration.</p>

\[\begin{eqnarray}
\Delta a &amp;=&amp; 0 - a_{max} = -a_{max} \\
\Delta t &amp;=&amp; \frac{-a_{max}}{j_{min}} = \frac{a_{max}}{j_{max}}
\end{eqnarray}\]

<p>Let $s_{s_3}$ denote the path length traversed by the robot while applying minimum jerk:</p>

\[\begin{eqnarray}
s_{s_3} &amp;=&amp; v_{s_2} \Delta t + \frac{1}{6} j_{min} \Delta t^3 \\
v_{s_3} &amp;=&amp; v_{s_2} + \frac{1}{2} j_{min} \Delta t^2.
\end{eqnarray}\]

<h4 id="section-4-cruise-initial-consideration">Section 4: Cruise, initial consideration.</h4>

<p>If the initial analysis showed that there was remaining path after doing the shooting method discussed, then there will be a cruise section.  The math of the cruise section is the easiest because there is no velocity change.  Logically, it makes the most sense to consider this segment last, because we will take whatever unaccounted-for length and apply it as a cruise section.</p>

<h4 id="section-5-minimum-jerk-part-2">Section 5: Minimum jerk, part 2</h4>

<p>At the end of the cruise section, or the end of the first minimum jerk section if there is no cruise section, apply minimum jerk again until max <em>deceleration</em> is reached.</p>

\[\begin{eqnarray}
\Delta a &amp;=&amp; a_{min} - 0 = -a_{max} \\
\Delta t &amp;=&amp; \frac{-a_{max}}{j_{min}} = \frac{a_{max}}{j_{max}}
\end{eqnarray}\]

<p>Let $s_{s_3}$ denote the path length traversed by the robot while again applying minimum jerk:</p>

\[\begin{eqnarray}
s_{s_5} &amp;=&amp; v'_{max} \Delta t + \frac{1}{6} j_{min} \Delta t^3 \\
v_{s_5} &amp;=&amp; v'_{max} + \frac{1}{2} j_{min} \Delta t^2.
\end{eqnarray}\]

<h4 id="section-6-minimum-acceleration">Section 6: Minimum acceleration</h4>

<p>The robot will continue decelerating at \(a_{min}\) until the time when it needs to apply maximum jerk to hit the terminal constraint of zero velocity and acceleration.</p>

\[\begin{eqnarray}
\Delta v &amp;=&amp; v_{s_5} - \frac{a_{min}^2}{2 j_{max}} \\
\Delta t &amp;=&amp; \frac{\Delta v}{a_{max}}
\end{eqnarray}\]

<p>Let $s_{s_6}$ denote the path length traversed by the robot while applying minimum acceleration:</p>

\[\begin{eqnarray}
s_{s_6} &amp;=&amp; v_{s_5} \Delta t + \frac{1}{2} a_{min} \Delta t^2 \\
v_{s_6} &amp;=&amp; v_{s_5} + a_{min} \Delta t.
\end{eqnarray}\]

<h4 id="section-7-maximum-jerk-part-2">Section 7: Maximum jerk, part 2</h4>

<p>Finally, to come to a stop at zero velocity we again apply maximum jerk.
\(\begin{eqnarray}
\Delta a &amp;=&amp; 0-a_{min} = a_{max} \\
\Delta t &amp;=&amp; \frac{\Delta a}{j_{max}}
\end{eqnarray}\)</p>

<p>Let $s_{s_7}$ denote the path length traversed by the robot while again applying maximum jerk:</p>

\[\begin{eqnarray}
s_{s_7} &amp;=&amp; v_{s_6} \Delta t - \frac{1}{6} j_{max} \Delta t^3. \\
v_{s_7} &amp;=&amp; v_{s_6} - \frac{1}{2} j_{max} \Delta t^2
\end{eqnarray}\]

<h4 id="section-4-cruise-final-consideration">Section 4: Cruise, final consideration</h4>

<p>At this point, we have everything we need to determine how long of a section we will be able to cruise along at \(v'_{max}\).  Upon construction of the path, we computed a total segment length, \(s_{tot}\), from which we will now subtract all of the computed segment lengths thus far:</p>

\[\begin{eqnarray}
s_{s_4} &amp;=&amp; s_{tot} - \sum_{i \neq 4} s_{s_i} \\
\Delta t &amp;=&amp; \frac{v'_{max}}{s_{s_4}},
\end{eqnarray}\]

<p>where, again, \(\Delta t\) is the time-of-traversal.</p>

<h3 id="implementation-details">Implementation Details</h3>

<h4 id="finding-the-point-along-the-curve-at-a-given-timevelocity">Finding the point along the curve at a given time/velocity</h4>
<p>Recall that paths are typically composed of segments stitched together, each one of which is parametrized by a continuous parameter \(u \in [0, 1]\).  Now that we are trying to overlay a velocity profile on top of these path segments, we need to be careful to correctly map our current point, as constructed by our integrated velocity profile, \(s(t) = \int_0^t v(\tau) d \tau\), to the corresponding \(u\) on the current path. The objective, stated mathematically, is:</p>

<blockquote>
  <p>For any \(t \in [0, T]\), \(T\) is the final trajectory time, find the \(u\) along the path such that 
\(\begin{equation}
s(u) \equiv \int_0^{u} \dot s(\tau) d \tau = \int_0^t v(\tau) d \tau
\end{equation}\) 
given a velocity profile that also parametrizes the path.  \(\dot s(\tau) \equiv \sqrt{\dot x(\tau)^2 + \dot y(\tau)^2}\).</p>
</blockquote>

<p>This problem is solved using the <a href="https://en.wikipedia.org/wiki/Fundamental_theorem_of_calculus" rel="external nofollow noopener" target="_blank">Fundamental Theorem of Calculus, part 1</a> together with a <a href="https://en.wikipedia.org/wiki/Newton%27s_method" rel="external nofollow noopener" target="_blank">Newton iteration</a> scheme.  The basic idea is that the two methods are used together to find the root of the nonlinear equation:</p>

\[\begin{equation}
f(u) = \int_0^u \dot s(\tau) d \tau - \int_0^t v(t) dt,
\end{equation}\]

<p>where \(t, v(t)\) are known and \(s(\tau)\) is constructed during the initial path building step.</p>

<h3 id="application">Application</h3>
<p>I begin with the path constructed in the <a href="../eta3path">previous post</a>:</p>

<p align="center"> 
<img src="/assets/img/smooth_path_post/Eta3Path.png">
</p>

<p>Now, I apply kinematic limits of \((v_{max}, a_{max}, j_{max}) = (2, 0.5, 1)\), where all units are SI.  The resulting trajectory, represented as a colormap, is:</p>

<p align="center"> 
<img src="/assets/img/trajectory_planner/colormap.png">
</p>

<p>The velocity profiles, shown on one chart with two \(y\)-axes, is:</p>

<p align="center"> 
<img src="/assets/img/trajectory_planner/velocities.png">
</p>

<p>As expected, given the work on the <a href="../eta3path">path planner</a>, the angular velocity is continuous.  For most applications, this is very important, as the angular velocity can lead to wheel slip, instability, or other undesirable effects.</p>

<h3 id="concluding-remarks">Concluding Remarks</h3>

<p>A way of overlaying a velocity profile over a segments connecting multiple waypoints was presented.  The velocity profile constructed obeys kinematic limits for maximum velocity, acceleration, and jerk.  The angular velocity signal was shown to be continuous, which reinforces the idea continuous curvature presented in the <a href="blog/2018/eta3path">\(\eta^3\) spline path planner</a>.  This mini-project was interesting and fun to work on.  I hope that you, the interested reader, will find something worthwhile in either this post or my work supporting it.  Cheers!</p>

  </article>


  
    
    <br>
    <hr>
    <br>
    <ul class="list-disc pl-8"></ul>

    <!-- Adds related posts to the end of an article -->
    <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2>
    <p class="mb-2">Here are some more articles you might like to read next:</p>
  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/displaying-external-posts-on-your-al-folio-blog/">Displaying External Posts on Your al-folio Blog</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/f110-pdm-board/">Building the F1TENTH Power Distribution Module (PDM)</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/goodbye-2021/">So long, 2021</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/max-clique/">Finding Point Cloud Correspondences Using Undirected Graphs</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/lookalike/">Celebrity Lookalike Project Writeup</a>
  </li>

</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2023 Joe  Dinius. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>

    

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
