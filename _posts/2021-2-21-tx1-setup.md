
---
layout: post
title:  Setting up a Jetson TX1
description: Steps that I followed setting up my TX1 for embedded systems development
date:   2021-2-20 07:30:00
comments: true
---

### Setting up JetPack using the SDKManager

* [SDKManager setup](https://developer.nvidia.com/nvidia-sdk-manager#dockersupport)
* [Docker command](https://docs.nvidia.com/sdk-manager/docker-containers/index.html#additional-considerations)
```bash
docker run -it --privileged -v /dev/bus/usb:/dev/bus/usb/ --name JetPack_NX_Devkit sdkmanager --cli install --logintype devzone --product Jetson --target {target p-number} --targetos Linux --version 4.4.1 --select 'Jetson OS' --deselect 'Jetson SDK Components' --flash all --license accept --staylogin true --datacollection enable --exitonfinish
```
Look under the section "Devices Supported by this Document" from [this page](https://docs.nvidia.com/jetson/l4t/) to get the argument to `--target` above.  _For the Jetson TX1, the target is_ P2180-1000.

### Connecting to the Jetson

Username: joe
Password: Aut0n0m0us!


#### Over USB

When plugged into the device using the micro-B interface, there should be a file explorer window that pops up.  You can read all about setting up your connection to your Jetson device in these files.  For me, I'm just connecting from the command line using ssh and the exposed 192.168.55.1 IP.  _I use ssh with the_ `-Y` _option to allow X11 forwarding of GUI apps over the connection._

### Setup New SSD

Follow instructions from [here](https://linuxize.com/post/fdisk-command-in-linux/) to setup a new SSD.  For me, the SSD was recognized as `/dev/sda`.

```bash
sudo fdisk /dev/sda  # pulls up fdisk prompt
g  # enter gpt options sub-menu 
n  # create partition (hit Enter to select defaults since I only want 1 partition) 
w  # write changes
# should now be back to command prompt (fdisk has exited)
sudo mkfs.ext4 -F /dev/sda1  # format new disk partition as ext4
```

Now, follow remaining process outlined by [JetsonHacks](https://www.jetsonhacks.com/2017/01/28/install-samsung-ssd-on-nvidia-jetson-tx1/).  _Note: the final extlinux.conf will look slightly different than the one shown in the blog post due to the updated l4t version installation on the TX1._

### Setting up Docker

* [Install Nvidia container packages]()
```bash
sudo apt-get install -y libnvidia-container-tools libnvidia-container0:arm64 nvidia-container-runtime nvidia-container-toolkit nvidia-docker2
sudo cat /etc/docker/daemon.json  # make sure nvidia runtime is there - you'll need to stop/start docker after making any changes to this file
sudo dpkg --get-selections | grep nvidia  # list installed packages, verify that *docker* and *container* are there
sudo docker info | grep nvidia  # verify nvidia runtime is shown
```
* [Manage Docker as non-root user](https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user)

### Setting up the VESC

Start from [here](jetsonhacks.com/2019/11/08/racecar-j-programming-the-electronic-speed-controller-2/)

* Clone the [`vesc_tool` repo](https://github.com/vedderb/vesc_tool.git)
* If you have a newer VESC
  * Follow instructions in [`build_lin`](https://github.com/vedderb/vesc_tool/blob/master/build_lin)
    * I chose to install v5.15 of Qt, so I followed the commented-out commands under `# Qt 5.15:`.  See [Qt 5.15 requirements](https://doc.qt.io/qt-5/linux-requirements.html) before trying to install.
* I have an older FOCBOX, so I started from [here](https://www.jetsonhacks.com/2018/02/13/racecar-j-programming-the-electronic-speed-controller/)
  * Installed [bldc-tool](https://github.com/RacecarJ/installBLDCTool/blob/master/installBLDCToolHost.sh) on my host machine before going to the Jetson
    * The `qmake -qt=qt5` line didn't work for me, so I removed the `-qt=qt5`
    * After this, I followed the steps from the [older VESC post ](https://www.jetsonhacks.com/2018/02/13/racecar-j-programming-the-electronic-speed-controller/) on the JetsonHacks website.  _Note: the installed FW version should show v2.18, which is pretty old as of March 2021_
    * After updating the FW, _don't disconnect power for at least 10 seconds to avoid the possibility of bricking the VESC_
  * On the Jetson
    * Add user to dialout group (otherwise you will see `Serial Port Error: 2` in bldc-tool when trying to connect to the VESC)
    ```bash
    sudo adduser $(whoami) dialout
    ```

### Teleop

#### Setting up the Logitech F710

* Need to update the kernel following steps [here](https://github.com/jetsonhacks/logitech-f710-module).  The version of Jetpack I'm using is 4.5 (with l4t 32.5.1), but the kernel module file is not yet available (as of 7 March 2021).  I used the `l4t-32-5-0` and it doesn't seem to have any adverse effects.  JetsonHacks recommends a cold reboot at this point, so I did that:
  ```bash
  (jetson) sudo shutdown -h now  # shutdown the jetson
  # watch the led's go out on the board before disconnecting power
  # disconnect power for a few seconds (say 10)
  # reconnect power and push power button
  (host) ssh -Y {username}@192.168.55.1
  (jetson) ls -l /dev/input  # should see device come up as /dev/input/js0
  ```
* Install `jstest`
  ```bash
  sudo apt-get install -y jstest-gtk  # pulls in jtest, plus gui
  ```
* Run `jstest` and button-mash.  You should see int16 values for the analog sticks and on/off registers for button presses.  This indicates the joystick is setup correctly.

#### ROS1 Teleop

Start from [here](https://github.com/mit-racecar/racecar_docker)

* Build docker image for the Jetson by changing the first line `FROM` to pull from `arm64v8/debian:stretch-slim`.  Additionally, I had to add `--allow-unauthenticated` to all of the `apt-get install` lines.  _Could also set this up on my host PC by using the Dockerfile, as-is_

